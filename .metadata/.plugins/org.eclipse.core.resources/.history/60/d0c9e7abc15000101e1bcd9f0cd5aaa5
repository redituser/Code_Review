<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>{{room.roomName}} - CODE CIRCLE</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.min.css">


<style>
	/* === ê¸°ë³¸ ë° ì „ì—­ ì„¤ì • === */
	:root {
		--color-bg-default: #0d1117;
		--color-bg-subtle: #161b22;
		--color-border-default: #30363d;
		--color-text-default: #e6edf3;
		--color-text-muted: #7d8590;
		--color-accent-primary: #1f6feb;
		--color-accent-success: #238636;
		--color-accent-success-hover: #2ea043;
		--color-accent-danger: #da3633;
		--color-accent-danger-hover: #f85149;
		--font-family-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI',
			'Noto Sans', Helvetica, Arial, sans-serif;
		--font-family-mono: 'SF Mono', 'Consolas', 'Liberation Mono', Menlo,
			monospace;
	}
	
	* {
		box-sizing: border-box;
	}
	
	body {
		font-family: var(--font-family-sans);
		background: var(--color-bg-default);
		color: var(--color-text-default);
		margin: 0;
		overflow: hidden; /* ì „ì²´ ìŠ¤í¬ë¡¤ ë°©ì§€ */
	}
	
	/* === ë ˆì´ì•„ì›ƒ === */
	.live-container {
		display: flex;
		height: 100vh;
	}
	
	.main-content {
		flex-grow: 1;
		display: flex; /* CodeMirrorê°€ ë†’ì´ë¥¼ ì±„ìš°ë„ë¡ */
	}
	
	.sidebar {
		width: 300px;
		background: var(--color-bg-subtle);
		border-right: 1px solid var(--color-border-default);
		display: flex;
		flex-direction: column;
		transition: transform 0.3s ease-in-out;
		position: fixed;
		left: 0;
		top: 0;
		height: 100%;
		z-index: 1001;
		transform: translateX(-100%);
	}
	
	.sidebar.open {
		transform: translateX(0);
	}
	
	.overlay {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.5);
		z-index: 1000;
		display: none;
	}
	
	.overlay.active {
		display: block;
	}
	
	/* === íŒ¨ë„ ìŠ¤íƒ€ì¼ === */
	.panel {
		background: var(--color-bg-subtle);
		border: 1px solid var(--color-border-default);
		border-radius: 6px;
		display: flex;
		flex-direction: column;
	}
	
	.panel-header {
		padding: 0.8rem 1rem;
		border-bottom: 1px solid var(--color-border-default);
		font-weight: 600;
	}
	
	/* === CodeMirror ì—ë””í„° íŒ¨ë„ === */
	.editor-panel {
		flex-grow: 1;
		display: flex;
		flex-direction: column;
		border: none;
		border-radius: 0;
	}
	
	.CodeMirror {
		font-family: var(--font-family-mono);
		font-size: 14px;
		height: auto; /* flex-growë¡œ ë†’ì´ ì¡°ì ˆ */
		flex-grow: 1;
	}
	
	/* === ì‚¬ì´ë“œë°” ë‚´ë¶€ ìš”ì†Œ === */
	#participantList {
		list-style: none;
		padding: 0.8rem 1rem;
		margin: 0;
		flex-grow: 1;
		overflow-y: auto;
	}
	
	#participantList li {
		padding: 0.5rem 0;
		color: var(--color-text-muted);
	}
	
	#participantList li.participant-item {
		color: var(--color-text-default);
	}
	
	.room-controls {
		padding: 1rem;
		border-top: 1px solid var(--color-border-default);
	}
	
	.control-group {
		margin-bottom: 1.2rem;
	}
	
	.control-group p {
		margin: 0 0 0.5rem 0;
		font-weight: 600;
	}
	
	.control-group input[type="text"] {
		width: 100%;
		padding: 0.5rem;
		background: var(--color-bg-default);
		border: 1px solid var(--color-border-default);
		color: var(--color-text-default);
		border-radius: 6px;
		transition: border-color 0.2s, box-shadow 0.2s;
	}
	
	.control-group input[type="text"]:focus {
		border-color: var(--color-accent-primary);
		box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.3);
		outline: none;
	}
	
	.btn {
		width: 100%;
		margin-top: 0.5rem;
		padding: 0.6rem;
		color: white;
		border: none;
		border-radius: 6px;
		cursor: pointer;
		font-weight: 600;
		transition: background-color 0.2s;
	}
	
	.btn-success {
		background-color: var(--color-accent-success);
	}
	
	.btn-success:hover {
		background-color: var(--color-accent-success-hover);
	}
	
	.btn-danger {
		background-color: var(--color-accent-danger);
	}
	
	.btn-danger:hover {
		background-color: var(--color-accent-danger-hover);
	}
	
	#sidebarToggle {
		position: fixed;
		top: 1rem;
		left: 1rem;
		z-index: 1002;
		background: none;
		border: none;
		cursor: pointer;
		padding: 5px;
	}
</style>
</head>
<body>
	<button id="sidebarToggle">
		<svg viewBox="0 0 100 80" width="25" height="25" fill="#e6edf3">
            <rect width="100" height="15" rx="8"></rect>
            <rect y="30" width="100" height="15" rx="8"></rect>
            <rect y="60" width="100" height="15" rx="8"></rect>
        </svg>
	</button>

	<div id="overlay" class="overlay"></div>

	<div class="live-container">

		<div id="sidebar" class="sidebar">
			<div class="panel-header">ì°¸ì—¬ì ëª©ë¡ &amp; ë©”ë‰´</div>
			<ul id="participantList" style="flex-grow: 1; overflow-y: auto;">
				<li>ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
			</ul>

			<div class="room-controls">

				<div class="control-group">
					<p>ë©¤ë²„ ì´ˆëŒ€</p>
					<input type="text" id="inviteMemberId" placeholder="ì´ˆëŒ€í•  ë©¤ë²„ ID">
					<button id="inviteButton" class="btn btn-success">ì´ˆëŒ€í•˜ê¸°</button>
				</div>

				<div class="control-group">
					<button id="leaveButton" class="btn btn-danger">ë°© ë‚˜ê°€ê¸°</button>
				</div>

				{{#isCreator}}
				<div class="control-group">
					<p style="margin-top: 1rem; border-top: 1px solid var(--color-border-default); padding-top: 1.2rem;">ë°©ì¥ ë©”ë‰´</p>
					<button id="deleteRoomButton" class="btn btn-danger" style="background-color: #8b2927;">ë°© ì‚­ì œí•˜ê¸°</button>
				</div>
				{{/isCreator}}
			</div>
		</div>

		<div class="main-content">
			<div class="editor-panel">
				<div class="panel-header">{{room.roomName}}</div>
				<textarea id="codeEditor" th:text="${room.currentCode}"></textarea>
			</div>
		</div>

	</div>


	<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/clike/clike.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/python/python.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/sql/sql.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/matchbrackets.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>

	<script th:inline="javascript">
    /*<![CDATA[*/

    // === ì „ì—­ ë³€ìˆ˜ ===
    const roomId = {{room.roomId}};
    const loginId = /*[[${loginId}]]*/ 'default_user_id';
    const creatorId = '{{room.creatorId}}';
    let stompClient = null;
    let codeMirrorEditor = null;


    // === DOM ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰ ===
    document.addEventListener('DOMContentLoaded', function() {
        initializeCodeMirror();
        setupEventListeners();
        connectToWebSocket();
        loadParticipants();
    });


    // === ì´ˆê¸°í™” í•¨ìˆ˜ ===

    function initializeCodeMirror() {
        const editorTextarea = document.getElementById('codeEditor');
        codeMirrorEditor = CodeMirror.fromTextArea(editorTextarea, {
            lineNumbers: true,
            mode: "text/x-java", // Java ëª¨ë“œë¡œ ì„¤ì • (MIME íƒ€ì…)
            theme: "dracula",
            matchBrackets: true,
            autoCloseBrackets: true,
            indentUnit: 4 // ë“¤ì—¬ì“°ê¸° 4ì¹¸
        });

        // CodeMirror ë‚´ìš© ë³€ê²½ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        codeMirrorEditor.on('change', (instance, changeObj) => {
        	console.log("CodeMirror 'change' ì´ë²¤íŠ¸ ë°œìƒ!", changeObj.origin);
            // ë‹¤ë¥¸ ì‚¬ëŒì— ì˜í•´ ì½”ë“œê°€ ë³€ê²½ëœ ê²½ìš°ëŠ” ì œì™¸ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
            if (changeObj.origin !== 'setValue') {
            	 console.log("sendCodeUpdate() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.");
                sendCodeUpdate();
            }
        });
    }

    function setupEventListeners() {
        document.getElementById('inviteButton').addEventListener('click', inviteMember);
        document.getElementById('leaveButton').addEventListener('click', leaveRoom);
        
        const deleteBtn = document.getElementById('deleteRoomButton');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', deleteRoom);
        }

        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        });

        overlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        });
    }


    // === WebSocket ê´€ë ¨ í•¨ìˆ˜ ===

    function connectToWebSocket() {
        const socket = new SockJS('/ws-stomp');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // ì½˜ì†”ì— Stomp ë””ë²„ê·¸ ë©”ì‹œì§€ ë„ê¸°

        stompClient.connect({}, (frame) => {
            console.log('ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤: ' + frame);
            
            stompClient.subscribe('/topic/room/' + roomId, (message) => {
                const update = JSON.parse(message.body);
                handleWebSocketMessage(update);
            });
        });
    }

    function handleWebSocketMessage(update) {
    	// [ë””ë²„ê¹… ì½”ë“œ ì¶”ê°€]
        console.log("WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ :", update);
    	
        if (update.type === 'CODE_UPDATE' && update.senderId !== loginId) {
            const cursorPos = codeMirrorEditor.getCursor(); // ë‚´ ì»¤ì„œ ìœ„ì¹˜ ì €ì¥
            codeMirrorEditor.setValue(update.editorContent);
            codeMirrorEditor.setCursor(cursorPos); // ë‚´ ì»¤ì„œ ìœ„ì¹˜ ë³µì›
        } else if (update.type === 'USER_JOIN' || update.type === 'USER_LEAVE') {
            console.log(update.senderId + 'ë‹˜ì´ ë°© ìƒíƒœë¥¼ ë³€ê²½í–ˆìŠµë‹ˆë‹¤. ì°¸ì—¬ì ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
            loadParticipants(); // ì°¸ì—¬ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else if (update.type === 'ROOM_DELETED') {
            stompClient.disconnect(() => {
                alert('ë°©ì¥ì´ ë°©ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = '/';
            });
        }
    }

    function sendCodeUpdate() {
        if (stompClient && codeMirrorEditor) {
            const updateMessage = {
                // [ìˆ˜ì •] ì—¬ê¸°ì— type ì†ì„±ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
                type: 'CODE_UPDATE',
                editorContent: codeMirrorEditor.getValue(),
                senderId: loginId
            };
            stompClient.send("/app/code/update/" + roomId, {}, JSON.stringify(updateMessage));
        }
    }


    // === API í˜¸ì¶œ ë° UI ë¡œì§ í•¨ìˆ˜ ===

    async function leaveRoom() {
        if (!confirm('ì •ë§ë¡œ ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        try {
            const response = await fetch(`/api/live-rooms/${roomId}/leave`, {
                method: 'POST'
            });
            if (response.ok) {
                alert('ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.');
                window.location.href = '/';
            } else {
                throw new Error('ë°©ì„ ë‚˜ê°€ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('Leave Room Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ë°©ì„ ë‚˜ê°€ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function inviteMember() {
        const inviteeIdInput = document.getElementById('inviteMemberId');
        const inviteeId = inviteeIdInput.value.trim();
        
        if (!inviteeId) {
            alert('ì´ˆëŒ€í•  ë©¤ë²„ì˜ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        try {
            const response = await fetch(`/api/live-rooms/${roomId}/invite`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ inviteeId: inviteeId }),
            });
            
            if (response.ok) {
                alert(`${inviteeId}ë‹˜ì„ ë°©ìœ¼ë¡œ ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤.`);
                inviteeIdInput.value = '';
            } else {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ì´ˆëŒ€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('Invite Error:', error);
            alert(error.message);
        }
    }

    async function deleteRoom() {
        if (!confirm('ë°©ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) return;
        
        try {
            const response = await fetch(`/api/live-rooms/${roomId}`, {
                method: 'DELETE',
            });
            
            if (response.ok) {
            	// ì„±ê³µ ì‹œì—ëŠ” ë³„ë„ alert ì—†ì´ ROOM_DELETED ë©”ì‹œì§€ë¥¼ í†µí•´ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë©ë‹ˆë‹¤.
            } else {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ë°© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('Delete Room Error:', error);
            alert(error.message);
        }
    }

    async function loadParticipants() {
        const listElement = document.getElementById('participantList');
        try {
            const response = await fetch(`/api/live-rooms/${roomId}/members`);
            if (!response.ok) throw new Error('ì°¸ì—¬ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');

            const participants = await response.json();
            
            if (participants && participants.length > 0) {
                 listElement.innerHTML = participants.map(p => {
                     const isCreator = p.memberId === creatorId;
                     const creatorBadge = isCreator ? ' <span style="color: #f8c555; font-size: 0.8em;">(ë°©ì¥ğŸ‘‘)</span>' : '';
                     return `<li class="participant-item">${p.nickname} (${p.memberId})${creatorBadge}</li>`;
                 }).join('');
            } else {
                 listElement.innerHTML = '<li>ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
            }
        } catch (error) {
            console.error('Load Participants Error:', error);
            listElement.innerHTML = '<li>ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>';
        }
    }
    
    /*]]>*/
    </script>
</body>
</html>